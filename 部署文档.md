# 语音实时转录接口 - 部署文档

## 📋 目录

1. [项目简介](#项目简介)
2. [环境要求](#环境要求)
3. [快速开始](#快速开始)
4. [部署方式](#部署方式)
   - [方式一：直接部署](#方式一直接部署)
   - [方式二：Docker 部署](#方式二docker-部署推荐)
   - [方式三：生产环境部署](#方式三生产环境部署)
5. [配置说明](#配置说明)
6. [测试验证](#测试验证)
7. [监控运维](#监控运维)
8. [常见问题](#常见问题)
9. [性能优化](#性能优化)

---

## 项目简介

本项目是基于 FunASR 的实时语音转录后端接口，支持 PTT（Push-to-Talk）模式，通过 WebSocket 实现实时双向通信。

### 核心特性

- ✅ **WebSocket 实时通信**：支持长连接和流式数据传输
- ✅ **PTT 模式**：支持 start/stop 控制指令
- ✅ **CPU 优化**：针对纯 CPU 环境优化，无需 GPU
- ✅ **高并发支持**：支持 10-20 个并发连接（CPU 环境）
- ✅ **FunASR 常驻**：模型预加载，快速响应
- ✅ **完善的监控**：提供健康检查和统计接口

### 技术栈

- **语言**: Python 3.8+
- **框架**: FastAPI + Uvicorn
- **ASR 引擎**: FunASR (阿里达摩院)
- **深度学习**: PyTorch (CPU 版本)
- **协议**: WebSocket

---

## 环境要求

### 硬件要求

| 组件 | 最低配置 | 推荐配置 |
|------|---------|---------|
| **CPU** | 2核心 | 4核心或更多 |
| **内存** | 4GB | 8GB 或更多 |
| **存储** | 10GB | 20GB 或更多 |

### 软件要求

| 软件 | 版本要求 |
|------|---------|
| **操作系统** | Ubuntu 20.04+ / CentOS 7+ / Windows 10+ |
| **Python** | 3.8 或更高 |
| **Docker** (可选) | 20.10+ |
| **Docker Compose** (可选) | 1.29+ |

---

## 快速开始

### 1. 克隆项目

```bash
git clone <repository_url>
cd asr
```

### 2. 查看项目结构

```
asr/
├── app.py                 # 主应用程序
├── config.py              # 配置文件
├── requirements.txt       # Python 依赖
├── Dockerfile             # Docker 镜像构建文件
├── docker-compose.yml     # Docker Compose 配置
├── nginx.conf             # Nginx 反向代理配置
├── test_client.py         # 测试客户端
├── .gitignore             # Git 忽略文件
└── 部署文档.md            # 本文档
```

### 3. 选择部署方式

- **开发测试**: 推荐 [方式一：直接部署](#方式一直接部署)
- **生产环境**: 推荐 [方式二：Docker 部署](#方式二docker-部署推荐)

---

## 部署方式

## 方式一：直接部署

适合开发测试环境。2

### Step 1: 创建虚拟环境

#### Linux/macOS:
```bash
python3 -m venv venv
source venv/bin/activate
```

#### Windows:
```powershell
python -m venv venv
.\venv\Scripts\activate
```

### Step 2: 安装依赖

```bash
# 升级 pip
pip install --upgrade pip

# 安装 PyTorch (CPU 版本)
pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu

# 安装其他依赖
pip install -r requirements.txt
```

> **注意**: 首次安装 FunASR 时会自动下载模型（约 300MB），请确保网络畅通。

### Step 3: 配置环境变量（可选）

创建 `.env` 文件或直接设置环境变量：

```bash
export HOST=0.0.0.0
export PORT=9999
export LOG_LEVEL=INFO
export MAX_CONNECTIONS=20
export TORCH_NUM_THREADS=4
```

### Step 4: 首次运行（下载模型）

```bash
# 预下载 FunASR 模型
python -c "from funasr import AutoModel; AutoModel(model='paraformer-zh-streaming', model_revision='v2.0.4', device='cpu')"
```

> 模型会下载到 `~/.cache/modelscope/` 目录。

### Step 5: 启动服务

```bash
# 方式 1: 直接运行
python app.py

# 方式 2: 使用 uvicorn（推荐）
uvicorn app:app --host 0.0.0.0 --port 9999 --log-level info

# 方式 3: 后台运行
nohup python app.py > logs/app.log 2>&1 &
```

### Step 6: 验证服务

```bash
# 检查服务状态
curl http://localhost:9999/

# 检查健康状态
curl http://localhost:9999/health

# 查看统计信息
curl http://localhost:9999/stats
```

---

## 方式二：Docker 部署（推荐）

适合生产环境，简化部署流程。

### 前置要求

确保已安装 Docker 和 Docker Compose：

```bash
# 检查 Docker 版本
docker --version

# 检查 Docker Compose 版本
docker-compose --version
```

### Step 1: 构建镜像

```bash
# 构建 Docker 镜像
docker-compose build

# 或使用 Docker 命令
docker build -t asr-service:latest .
```

> **注意**: 首次构建会下载 FunASR 模型，需要约 5-10 分钟。

### Step 2: 启动服务

```bash
# 启动服务（后台运行）
docker-compose up -d

# 查看日志
docker-compose logs -f asr-service
```

### Step 3: 验证服务

```bash
# 检查容器状态
docker-compose ps

# 检查服务健康
curl http://localhost:9999/health
```

### Step 4: 停止服务

```bash
# 停止服务
docker-compose down

# 停止并删除卷
docker-compose down -v
```

### Docker Compose 配置说明

`docker-compose.yml` 中的重要配置：

```yaml
services:
  asr-service:
    ports:
      - "9999:9999"              # 端口映射
    volumes:
      - ./models:/root/.cache/modelscope  # 持久化模型
      - ./logs:/app/logs                  # 持久化日志
    environment:
      - MAX_CONNECTIONS=20       # 最大连接数
      - TORCH_NUM_THREADS=4      # CPU 线程数
    deploy:
      resources:
        limits:
          cpus: '4'              # CPU 限制
          memory: 8G             # 内存限制
```

---

## 方式三：生产环境部署

适合高可用、高性能的生产环境。

### 架构图

```
        ┌─────────────┐
        │   Nginx     │  (反向代理 + 负载均衡)
        └──────┬──────┘
               │
      ┌────────┼────────┐
      │        │        │
   ┌──▼──┐  ┌─▼───┐  ┌─▼───┐
   │ASR-1│  │ASR-2│  │ASR-3│  (多实例)
   └─────┘  └─────┘  └─────┘
```

### Step 1: 部署多个服务实例

#### 方式 A: Docker Compose 扩展

```bash
# 启动 3 个实例
docker-compose up -d --scale asr-service=3
```

#### 方式 B: 多个独立实例

修改 `docker-compose.yml`，创建多个服务：

```yaml
services:
  asr-service-1:
    build: .
    ports:
      - "9991:9999"
    # ... 其他配置

  asr-service-2:
    build: .
    ports:
      - "9992:9999"
    # ... 其他配置

  asr-service-3:
    build: .
    ports:
      - "9993:9999"
    # ... 其他配置
```

启动所有实例：

```bash
docker-compose up -d
```

### Step 2: 配置 Nginx 反向代理

#### 安装 Nginx

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install nginx

# CentOS/RHEL
sudo yum install nginx
```

#### 配置 Nginx

复制项目中的 `nginx.conf` 到 Nginx 配置目录：

```bash
sudo cp nginx.conf /etc/nginx/sites-available/asr
sudo ln -s /etc/nginx/sites-available/asr /etc/nginx/sites-enabled/
```

编辑 `/etc/nginx/sites-available/asr`，修改 upstream 配置：

```nginx
upstream asr_backend {
    # 负载均衡策略（轮询）
    server 127.0.0.1:9991;
    server 127.0.0.1:9992;
    server 127.0.0.1:9993;
}
```

#### 测试并重启 Nginx

```bash
# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx

# 设置开机自启
sudo systemctl enable nginx
```

### Step 3: 配置 HTTPS（推荐）

使用 Let's Encrypt 免费 SSL 证书：

```bash
# 安装 Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取证书并自动配置 Nginx
sudo certbot --nginx -d your-domain.com

# 设置自动续期
sudo certbot renew --dry-run
```

### Step 4: 配置防火墙

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### Step 5: 配置系统服务（Systemd）

创建 `/etc/systemd/system/asr.service`:

```ini
[Unit]
Description=ASR Real-time Speech Recognition Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/asr
Environment="PATH=/path/to/asr/venv/bin"
ExecStart=/path/to/asr/venv/bin/uvicorn app:app --host 0.0.0.0 --port 9999
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl start asr
sudo systemctl enable asr
sudo systemctl status asr
```

---

## 配置说明

### 环境变量配置

在 `.env` 文件或系统环境变量中配置：

| 环境变量 | 默认值 | 说明 |
|---------|-------|------|
| `HOST` | `0.0.0.0` | 监听地址 |
| `PORT` | `9999` | 监听端口 |
| `LOG_LEVEL` | `INFO` | 日志级别 (DEBUG/INFO/WARNING/ERROR) |
| `MAX_CONNECTIONS` | `20` | 最大并发连接数 |
| `WS_TIMEOUT` | `300` | WebSocket 超时时间（秒） |
| `TORCH_NUM_THREADS` | `4` | PyTorch CPU 线程数 |
| `OMP_NUM_THREADS` | `4` | OpenMP 线程数 |
| `MKL_NUM_THREADS` | `4` | MKL 线程数 |
| `MODEL_NAME` | `paraformer-zh-streaming` | FunASR 模型名称 |
| `DEVICE` | `cpu` | 计算设备 (cpu/cuda) |

### 性能调优参数

根据服务器 CPU 核心数调整：

```bash
# 4核心 CPU
export TORCH_NUM_THREADS=4
export OMP_NUM_THREADS=4
export MKL_NUM_THREADS=4

# 8核心 CPU
export TORCH_NUM_THREADS=8
export OMP_NUM_THREADS=8
export MKL_NUM_THREADS=8
```

---

## 测试验证

### 1. 基础测试

#### 测试 HTTP 接口

```bash
# 根路径
curl http://localhost:9999/

# 健康检查
curl http://localhost:9999/health

# 统计信息
curl http://localhost:9999/stats
```

#### 访问测试页面

打开浏览器访问：`http://localhost:9999/test`

使用测试页面进行 WebSocket 连接测试。

### 2. 自动化测试

运行测试脚本：

```bash
# 确保服务已启动
python test_client.py
```

测试脚本会执行以下测试：
- ✅ 基本连接测试
- ✅ 控制指令测试 (start/stop/reset)
- ✅ 音频数据处理测试
- ✅ 完整工作流程测试
- ✅ 多连接并发测试
- ✅ 无效消息处理测试

### 3. 压力测试

#### 使用 k6 进行 WebSocket 压力测试

安装 k6:
```bash
# macOS
brew install k6

# Linux
sudo apt-get install k6
```

创建测试脚本 `load_test.js`:

```javascript
import ws from 'k6/ws';
import { check } from 'k6';

export let options = {
  vus: 10,          // 10 个虚拟用户
  duration: '30s',  // 持续 30 秒
};

export default function () {
  const url = 'ws://localhost:9999/ws/asr';
  const response = ws.connect(url, function (socket) {
    socket.on('open', () => console.log('connected'));
    socket.on('message', (data) => console.log('Message received: ', data));
    socket.on('close', () => console.log('disconnected'));
    socket.setTimeout(() => {
      socket.close();
    }, 10000);
  });
  check(response, { 'status is 101': (r) => r && r.status === 101 });
}
```

运行压力测试:
```bash
k6 run load_test.js
```

---

## 监控运维

### 1. 日志管理

#### 查看日志

```bash
# 直接部署
tail -f logs/asr.log

# Docker 部署
docker-compose logs -f asr-service

# 查看最近 100 行
docker-compose logs --tail=100 asr-service
```

#### 日志轮转

日志文件会自动轮转（配置在 `app.py` 中）：
- 单个日志文件最大 10MB
- 保留最近 5 个备份文件

### 2. 健康检查

```bash
# 手动检查
curl http://localhost:9999/health

# 定时检查（每 30 秒）
watch -n 30 'curl -s http://localhost:9999/health | jq'
```

健康检查返回示例：

```json
{
  "status": "healthy",
  "model_loaded": true,
  "active_connections": 5,
  "max_connections": 20,
  "cpu_usage_percent": 45.2,
  "memory_usage_percent": 62.8,
  "timestamp": "2024-10-28T12:34:56"
}
```

### 3. 性能监控

#### 监控 CPU 和内存

```bash
# 查看容器资源使用
docker stats asr-service

# 使用 htop
htop

# 使用 top
top -p $(pgrep -f "python app.py")
```

#### 监控连接数

```bash
# 查看当前连接数
curl -s http://localhost:9999/stats | jq '.active_connections'
```

### 4. 备份与恢复

#### 备份模型和日志

```bash
# 备份模型缓存
tar -czf models_backup_$(date +%Y%m%d).tar.gz models/

# 备份日志
tar -czf logs_backup_$(date +%Y%m%d).tar.gz logs/
```

#### 恢复

```bash
# 解压模型
tar -xzf models_backup_20241028.tar.gz

# 解压日志
tar -xzf logs_backup_20241028.tar.gz
```

### 5. 故障排查

#### 服务无法启动

检查日志：
```bash
# 直接部署
cat logs/asr.log

# Docker 部署
docker-compose logs asr-service
```

常见问题：
- 端口被占用：修改 `PORT` 环境变量
- 内存不足：检查可用内存，关闭其他进程
- 模型下载失败：检查网络，手动下载模型

#### WebSocket 连接失败

检查项：
1. 服务是否正常运行：`curl http://localhost:9999/health`
2. 防火墙是否允许端口访问
3. Nginx 配置是否正确（如果使用）
4. 查看服务日志

#### 识别速度慢

优化建议：
1. 增加 CPU 线程数：`TORCH_NUM_THREADS=8`
2. 使用更强大的 CPU
3. 部署多实例 + 负载均衡
4. 考虑使用 GPU 版本

---

## 常见问题

### Q1: 模型下载很慢怎么办？

**A**: 可以手动下载模型到指定目录：

```bash
# 创建目录
mkdir -p ~/.cache/modelscope/hub/damo/speech_paraformer-large_asr_nat-zh-cn-16k-common-vocab8404-pytorch

# 从 ModelScope 下载模型文件
# 访问: https://www.modelscope.cn/models/damo/speech_paraformer-large_asr_nat-zh-cn-16k-common-vocab8404-pytorch
```

### Q2: 如何提高并发连接数？

**A**: 修改 `MAX_CONNECTIONS` 环境变量：

```bash
export MAX_CONNECTIONS=50
```

**注意**: 并发数受 CPU 性能限制，建议根据实际测试调整。

### Q3: 可以使用 GPU 吗？

**A**: 可以，修改配置：

1. 安装 PyTorch GPU 版本
2. 修改环境变量：`export DEVICE=cuda`
3. Docker 部署需要使用 nvidia-docker

### Q4: 如何修改模型？

**A**: 修改 `MODEL_NAME` 环境变量：

```bash
# 使用其他中文模型
export MODEL_NAME=paraformer-zh

# 使用英文模型
export MODEL_NAME=paraformer-en-streaming
```

### Q5: WebSocket 连接经常断开？

**A**: 增加超时时间：

```bash
export WS_TIMEOUT=600  # 10分钟
```

同时在 Nginx 中增加超时配置（如果使用）。

### Q6: 如何查看详细日志？

**A**: 修改日志级别：

```bash
export LOG_LEVEL=DEBUG
```

### Q7: 支持 Windows 部署吗？

**A**: 支持，有两种方式：
1. 使用 Docker Desktop + Docker Compose（推荐）
2. 直接在 Windows 上安装 Python 环境

### Q8: 如何实现负载均衡？

**A**: 使用 Nginx 反向代理，配置多个 upstream：

```nginx
upstream asr_backend {
    server 127.0.0.1:9991;
    server 127.0.0.1:9992;
    server 127.0.0.1:9993;
}
```

---

## 性能优化

### CPU 优化

1. **调整线程数**

```bash
# 根据 CPU 核心数设置（一般设为核心数）
export TORCH_NUM_THREADS=8
export OMP_NUM_THREADS=8
export MKL_NUM_THREADS=8
```

2. **进程优先级**

```bash
# Linux 下提高进程优先级
nice -n -10 python app.py
```

### 内存优化

1. **限制并发连接**

```bash
export MAX_CONNECTIONS=10  # 减少并发数
```

2. **监控内存使用**

```bash
# 定期检查内存
watch -n 5 'free -m'
```

### 网络优化

1. **Nginx 配置优化**

```nginx
# 禁用缓冲
proxy_buffering off;

# 增加超时
proxy_read_timeout 300s;
```

2. **WebSocket 保活**

客户端实现心跳机制，定期发送 ping 消息。

### 并发优化

1. **多实例部署**

部署多个服务实例 + Nginx 负载均衡。

2. **异步处理**

代码中已使用 FastAPI 的异步处理，无需额外配置。

---

## 附录

### A. 完整启动检查清单

- [ ] Python 3.8+ 已安装
- [ ] 依赖包已安装
- [ ] FunASR 模型已下载
- [ ] 端口 9999 未被占用
- [ ] 防火墙已配置
- [ ] 日志目录已创建
- [ ] 环境变量已配置

### B. 生产环境安全建议

- [ ] 使用 HTTPS/WSS 加密传输
- [ ] 配置防火墙规则
- [ ] 限制 API 访问速率
- [ ] 定期备份模型和日志
- [ ] 监控服务健康状态
- [ ] 配置日志轮转
- [ ] 使用强密码和密钥

### C. 相关资源

- **FunASR 文档**: https://github.com/alibaba-damo-academy/FunASR
- **FastAPI 文档**: https://fastapi.tiangolo.com/
- **Docker 文档**: https://docs.docker.com/
- **Nginx 文档**: https://nginx.org/en/docs/

---

## 技术支持

如有问题，请通过以下方式联系：

- 📧 Email: support@your-domain.com
- 💬 Issue: GitHub Issues
- 📚 文档: 查看开发文档

---

**版本**: v2.1.0  
**更新日期**: 2024-10-28  
**文档状态**: 已完成  
**适用环境**: CPU 服务器

